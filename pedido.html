<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Pedido - Pastelería Mil Sabores</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <div class="nav-container">
                <div class="logo">
                    <h1 class="logo-text">🍰 Mil Sabores</h1>
                    <span class="logo-subtitle">50 años de tradición</span>
                </div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="index.html" class="nav-link">Inicio</a></li>
                    <li class="nav-item"><a href="index.html#productos" class="nav-link">Productos</a></li>
                    <li class="nav-item"><a href="index.html#nosotros" class="nav-link">Nosotros</a></li>
                    <li class="nav-item"><a href="index.html#contacto" class="nav-link">Contacto</a></li>
                    <li class="nav-item"><a href="login.html" class="nav-link" id="loginBtn">Iniciar Sesión</a></li>
                    <li class="nav-item"><a href="carrito.html" class="nav-link cart-link" id="cartBtn"><i class="fas fa-shopping-cart"></i> <span id="cartCount">0</span></a></li>
                </ul>
                <div class="hamburger">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </div>
        </nav>
    </header>

    <main class="checkout-main">
        <div class="container">
            <div class="checkout-header">
                <h1><i class="fas fa-credit-card"></i> Finalizar Pedido</h1>
                <div class="checkout-steps">
                    <div class="step active">
                        <span class="step-number">1</span>
                        <span class="step-label">Información</span>
                    </div>
                    <div class="step">
                        <span class="step-number">2</span>
                        <span class="step-label">Entrega</span>
                    </div>
                    <div class="step">
                        <span class="step-number">3</span>
                        <span class="step-label">Pago</span>
                    </div>
                    <div class="step">
                        <span class="step-number">4</span>
                        <span class="step-label">Confirmación</span>
                    </div>
                </div>
            </div>

            <div class="checkout-content">
                <div class="checkout-form-section">
                    <!-- Paso 1: Información de contacto -->
                    <div class="checkout-step-content" id="step1">
                        <h2>Información de Contacto</h2>
                        <form id="contactForm" class="checkout-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="contactName">Nombre completo *</label>
                                    <input type="text" id="contactName" required>
                                </div>
                                <div class="form-group">
                                    <label for="contactPhone">Teléfono *</label>
                                    <input type="tel" id="contactPhone" placeholder="+56 9 XXXX XXXX" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="contactEmail">Correo electrónico *</label>
                                <input type="email" id="contactEmail" required readonly>
                            </div>
                            <div class="form-group">
                                <label for="specialRequests">Solicitudes especiales</label>
                                <textarea id="specialRequests" placeholder="Ej: Sin nueces, decoración específica, etc."></textarea>
                            </div>
                        </form>
                    </div>

                    <!-- Paso 2: Información de entrega -->
                    <div class="checkout-step-content" id="step2" style="display: none;">
                        <h2>Información de Entrega</h2>
                        <form id="deliveryForm" class="checkout-form">
                            <div class="delivery-options">
                                <label class="delivery-option">
                                    <input type="radio" name="deliveryType" value="delivery" checked>
                                    <div class="option-content">
                                        <i class="fas fa-truck"></i>
                                        <div>
                                            <h4>Entrega a domicilio</h4>
                                            <p>Gratis en Santiago Centro</p>
                                        </div>
                                    </div>
                                </label>
                                <label class="delivery-option">
                                    <input type="radio" name="deliveryType" value="pickup">
                                    <div class="option-content">
                                        <i class="fas fa-store"></i>
                                        <div>
                                            <h4>Retiro en tienda</h4>
                                            <p>Disponible en 2-3 días hábiles</p>
                                        </div>
                                    </div>
                                </label>
                            </div>

                            <div id="deliveryAddress" class="delivery-address">
                                <h3>Dirección de entrega</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="address">Dirección *</label>
                                        <input type="text" id="address" placeholder="Calle Principal 123" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="addressNumber">Número</label>
                                        <input type="text" id="addressNumber" placeholder="123">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="commune">Comuna *</label>
                                        <select id="commune" required>
                                            <option value="">Seleccionar comuna</option>
                                            <option value="santiago">Santiago</option>
                                            <option value="providencia">Providencia</option>
                                            <option value="las-condes">Las Condes</option>
                                            <option value="vitacura">Vitacura</option>
                                            <option value="ñuñoa">Ñuñoa</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="region">Región</label>
                                        <input type="text" id="region" value="Región Metropolitana" readonly>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="addressReference">Referencia</label>
                                    <input type="text" id="addressReference" placeholder="Ej: Casa azul, portón café">
                                </div>
                            </div>

                            <div class="delivery-date">
                                <h3>Fecha y hora de entrega</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="deliveryDate">Fecha preferida *</label>
                                        <input type="date" id="deliveryDate" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="deliveryTime">Horario preferido</label>
                                        <select id="deliveryTime">
                                            <option value="morning">Mañana (09:00 - 12:00)</option>
                                            <option value="afternoon">Tarde (14:00 - 17:00)</option>
                                            <option value="evening">Noche (18:00 - 20:00)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Paso 3: Método de pago -->
                    <div class="checkout-step-content" id="step3" style="display: none;">
                        <h2>Método de Pago</h2>
                        <div class="payment-methods">
                            <label class="payment-method">
                                <input type="radio" name="paymentMethod" value="card" checked>
                                <div class="method-content">
                                    <i class="fas fa-credit-card"></i>
                                    <span>Tarjeta de Crédito/Débito</span>
                                </div>
                            </label>
                            <label class="payment-method">
                                <input type="radio" name="paymentMethod" value="transfer">
                                <div class="method-content">
                                    <i class="fas fa-university"></i>
                                    <span>Transferencia Bancaria</span>
                                </div>
                            </label>
                            <label class="payment-method">
                                <input type="radio" name="paymentMethod" value="cash">
                                <div class="method-content">
                                    <i class="fas fa-money-bill"></i>
                                    <span>Pago en Efectivo (contra entrega)</span>
                                </div>
                            </label>
                        </div>

                        <div id="cardPayment" class="payment-form">
                            <h3>Información de la tarjeta</h3>
                            <div class="form-group">
                                <label for="cardNumber">Número de tarjeta *</label>
                                <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="expiryDate">Fecha de vencimiento *</label>
                                    <input type="text" id="expiryDate" placeholder="MM/AA" maxlength="5">
                                </div>
                                <div class="form-group">
                                    <label for="cvv">CVV *</label>
                                    <input type="text" id="cvv" placeholder="123" maxlength="4">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="cardName">Nombre en la tarjeta *</label>
                                <input type="text" id="cardName" placeholder="Como aparece en la tarjeta">
                            </div>
                        </div>
                    </div>

                    <!-- Paso 4: Confirmación -->
                    <div class="checkout-step-content" id="step4" style="display: none;">
                        <div class="order-confirmation">
                            <div class="confirmation-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h2>¡Pedido Confirmado!</h2>
                            <p>Tu pedido ha sido procesado exitosamente</p>
                            
                            <div class="order-details" id="orderDetails">
                                <!-- Los detalles del pedido se llenarán aquí -->
                            </div>
                            
                            <div class="next-steps">
                                <h3>¿Qué sigue?</h3>
                                <div class="steps-list">
                                    <div class="step-item">
                                        <i class="fas fa-envelope"></i>
                                        <span>Te enviaremos un email de confirmación</span>
                                    </div>
                                    <div class="step-item">
                                        <i class="fas fa-clock"></i>
                                        <span>Comenzaremos a preparar tu pedido</span>
                                    </div>
                                    <div class="step-item">
                                        <i class="fas fa-truck"></i>
                                        <span>Te notificaremos cuando esté listo para entrega</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="confirmation-actions">
                                <button onclick="window.location.href='index.html'" class="primary-btn">
                                    <i class="fas fa-home"></i> Volver al Inicio
                                </button>
                                <button onclick="window.print()" class="secondary-btn">
                                    <i class="fas fa-print"></i> Imprimir Recibo
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de navegación -->
                    <div class="checkout-navigation">
                        <button id="prevBtn" onclick="changeStep(-1)" style="display: none;">
                            <i class="fas fa-arrow-left"></i> Anterior
                        </button>
                        <button id="nextBtn" onclick="changeStep(1)">
                            Siguiente <i class="fas fa-arrow-right"></i>
                        </button>
                        <button id="submitBtn" onclick="submitOrder()" style="display: none;">
                            <i class="fas fa-check"></i> Confirmar Pedido
                        </button>
                    </div>
                </div>

                <!-- Resumen del pedido -->
                <div class="order-summary-section">
                    <div class="order-summary-card">
                        <h3>Resumen del Pedido</h3>
                        
                        <div class="summary-items" id="summaryItems">
                            <!-- Items del carrito -->
                        </div>
                        
                        <div class="summary-totals">
                            <div class="summary-line">
                                <span>Subtotal:</span>
                                <span>$<span id="summarySubtotal">0</span></span>
                            </div>
                            <div class="summary-line discount-line" id="summaryDiscountLine" style="display: none;">
                                <span>Descuento:</span>
                                <span class="discount-amount">-$<span id="summaryDiscountAmount">0</span></span>
                            </div>
                            <div class="summary-line">
                                <span>Envío:</span>
                                <span>Gratis</span>
                            </div>
                            <hr>
                            <div class="summary-line total-line">
                                <span><strong>Total:</strong></span>
                                <span><strong>$<span id="summaryTotal">0</span></strong></span>
                            </div>
                        </div>
                        
                        <div class="security-badges">
                            <div class="security-item">
                                <i class="fas fa-shield-alt"></i>
                                <span>Compra Segura</span>
                            </div>
                            <div class="security-item">
                                <i class="fas fa-lock"></i>
                                <span>SSL Encriptado</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Pastelería Mil Sabores</h3>
                    <p>50 años endulzando momentos especiales</p>
                </div>
                <div class="footer-section">
                    <h4>Enlaces Rápidos</h4>
                    <ul>
                        <li><a href="index.html">Inicio</a></li>
                        <li><a href="index.html#productos">Productos</a></li>
                        <li><a href="index.html#nosotros">Nosotros</a></li>
                        <li><a href="index.html#contacto">Contacto</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Síguenos</h4>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Pastelería Mil Sabores. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        let currentStep = 1;
        const totalSteps = 4;

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si hay productos en el carrito y usuario logueado
            if (cart.length === 0) {
                alert('Tu carrito está vacío');
                window.location.href = 'carrito.html';
                return;
            }
            
            if (!user) {
                alert('Debes iniciar sesión para realizar un pedido');
                window.location.href = 'login.html';
                return;
            }

            loadCartFromStorage();
            updateCartDisplay();
            loadOrderSummary();
            loadUserInfo();
            setupEventListeners();
            setMinDeliveryDate();
        });

        function loadOrderSummary() {
            const summaryItems = document.getElementById('summaryItems');
            const summarySubtotal = document.getElementById('summarySubtotal');
            const summaryDiscountAmount = document.getElementById('summaryDiscountAmount');
            const summaryDiscountLine = document.getElementById('summaryDiscountLine');
            const summaryTotal = document.getElementById('summaryTotal');

            // Mostrar items
            summaryItems.innerHTML = cart.map(item => `
                <div class="summary-item">
                    <div class="item-info">
                        <span class="item-emoji">${item.image}</span>
                        <div>
                            <div class="item-name">${item.name}</div>
                            <div class="item-details">Cantidad: ${item.quantity}</div>
                            ${item.customMessage ? `<div class="item-message">"${item.customMessage}"</div>` : ''}
                        </div>
                    </div>
                    <div class="item-price">$${(item.price * item.quantity).toLocaleString('es-CL')}</div>
                </div>
            `).join('');

            // Calcular totales
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discountData = calculateDiscount(subtotal);
            const total = subtotal - discountData.amount;

            summarySubtotal.textContent = subtotal.toLocaleString('es-CL');
            summaryTotal.textContent = total.toLocaleString('es-CL');

            if (discountData.amount > 0) {
                summaryDiscountAmount.textContent = discountData.amount.toLocaleString('es-CL');
                summaryDiscountLine.style.display = 'flex';
            }
        }

        function loadUserInfo() {
            document.getElementById('contactName').value = user.name || '';
            document.getElementById('contactEmail').value = user.email || '';
        }

        function setupEventListeners() {
            // Tipo de entrega
            document.querySelectorAll('input[name="deliveryType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const addressSection = document.getElementById('deliveryAddress');
                    if (this.value === 'delivery') {
                        addressSection.style.display = 'block';
                    } else {
                        addressSection.style.display = 'none';
                    }
                });
            });

            // Método de pago
            document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const cardPayment = document.getElementById('cardPayment');
                    if (this.value === 'card') {
                        cardPayment.style.display = 'block';
                    } else {
                        cardPayment.style.display = 'none';
                    }
                });
            });

            // Formateo de número de tarjeta
            document.getElementById('cardNumber').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formattedValue;
            });

            // Formateo de fecha de vencimiento
            document.getElementById('expiryDate').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });
        }

        function setMinDeliveryDate() {
            const today = new Date();
            const minDate = new Date(today.getTime() + (2 * 24 * 60 * 60 * 1000)); // 2 días mínimo
            document.getElementById('deliveryDate').min = minDate.toISOString().split('T')[0];
        }

        function changeStep(direction) {
            if (direction === 1 && !validateCurrentStep()) {
                return;
            }

            currentStep += direction;
            
            if (currentStep < 1) currentStep = 1;
            if (currentStep > totalSteps) currentStep = totalSteps;

            updateStepDisplay();
        }

        function validateCurrentStep() {
            switch(currentStep) {
                case 1:
                    const contactForm = document.getElementById('contactForm');
                    return contactForm.checkValidity();
                case 2:
                    const deliveryForm = document.getElementById('deliveryForm');
                    return deliveryForm.checkValidity();
                case 3:
                    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                    if (paymentMethod === 'card') {
                        const cardNumber = document.getElementById('cardNumber').value;
                        const expiryDate = document.getElementById('expiryDate').value;
                        const cvv = document.getElementById('cvv').value;
                        const cardName = document.getElementById('cardName').value;
                        
                        return cardNumber.length >= 16 && expiryDate.length === 5 && 
                               cvv.length >= 3 && cardName.trim().length > 0;
                    }
                    return true;
            }
            return true;
        }

        function updateStepDisplay() {
            // Ocultar todas las secciones
            for (let i = 1; i <= totalSteps; i++) {
                document.getElementById(`step${i}`).style.display = 'none';
            }
            
            // Mostrar la sección actual
            document.getElementById(`step${currentStep}`).style.display = 'block';
            
            // Actualizar indicadores de pasos
            document.querySelectorAll('.step').forEach((step, index) => {
                if (index + 1 <= currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
            
            // Actualizar botones
            document.getElementById('prevBtn').style.display = currentStep > 1 ? 'block' : 'none';
            document.getElementById('nextBtn').style.display = currentStep < 3 ? 'block' : 'none';
            document.getElementById('submitBtn').style.display = currentStep === 3 ? 'block' : 'none';
        }

        function submitOrder() {
            if (!validateCurrentStep()) {
                alert('Por favor completa todos los campos requeridos');
                return;
            }

            // Recopilar datos del pedido
            const orderData = {
                customer: {
                    name: document.getElementById('contactName').value,
                    phone: document.getElementById('contactPhone').value,
                    email: document.getElementById('contactEmail').value
                },
                delivery: {
                    type: document.querySelector('input[name="deliveryType"]:checked').value,
                    address: document.getElementById('address').value,
                    commune: document.getElementById('commune').value,
                    date: document.getElementById('deliveryDate').value,
                    time: document.getElementById('deliveryTime').value
                },
                payment: {
                    method: document.querySelector('input[name="paymentMethod"]:checked').value
                },
                items: cart,
                totals: {
                    subtotal: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    discount: calculateDiscount(cart.reduce((sum, item) => sum + (item.price * item.quantity), 0)).amount,
                    total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) - calculateDiscount(cart.reduce((sum, item) => sum + (item.price * item.quantity), 0)).amount
                },
                orderNumber: 'ORD-' + Date.now(),
                date: new Date().toISOString()
            };

            // Mostrar confirmación
            showOrderConfirmation(orderData);
            
            // Limpiar carrito
            cart = [];
            saveCartToStorage();
            updateCartDisplay();
            
            // Ir al paso de confirmación
            currentStep = 4;
            updateStepDisplay();
        }

        function showOrderConfirmation(orderData) {
            const orderDetails = document.getElementById('orderDetails');
            
            orderDetails.innerHTML = `
                <div class="order-summary">
                    <div class="order-number">
                        <h3>Número de Pedido: ${orderData.orderNumber}</h3>
                        <p>Fecha: ${new Date().toLocaleDateString('es-CL')}</p>
                    </div>
                    
                    <div class="order-customer">
                        <h4>Información del Cliente</h4>
                        <p><strong>Nombre:</strong> ${orderData.customer.name}</p>
                        <p><strong>Email:</strong> ${orderData.customer.email}</p>
                        <p><strong>Teléfono:</strong> ${orderData.customer.phone}</p>
                    </div>
                    
                    <div class="order-delivery">
                        <h4>Entrega</h4>
                        <p><strong>Tipo:</strong> ${orderData.delivery.type === 'delivery' ? 'Entrega a domicilio' : 'Retiro en tienda'}</p>
                        ${orderData.delivery.type === 'delivery' ? `
                            <p><strong>Dirección:</strong> ${orderData.delivery.address}, ${orderData.delivery.commune}</p>
                        ` : ''}
                        <p><strong>Fecha:</strong> ${new Date(orderData.delivery.date).toLocaleDateString('es-CL')}</p>
                        <p><strong>Horario:</strong> ${getTimeSlotText(orderData.delivery.time)}</p>
                    </div>
                    
                    <div class="order-items">
                        <h4>Productos</h4>
                        ${orderData.items.map(item => `
                            <div class="order-item">
                                <span>${item.image} ${item.name} (x${item.quantity})</span>
                                <span>$${(item.price * item.quantity).toLocaleString('es-CL')}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="order-totals">
                        <div class="order-total-line">
                            <span>Subtotal:</span>
                            <span>$${orderData.totals.subtotal.toLocaleString('es-CL')}</span>
                        </div>
                        ${orderData.totals.discount > 0 ? `
                            <div class="order-total-line discount">
                                <span>Descuento:</span>
                                <span>-$${orderData.totals.discount.toLocaleString('es-CL')}</span>
                            </div>
                        ` : ''}
                        <div class="order-total-line total">
                            <span><strong>Total:</strong></span>
                            <span><strong>$${orderData.totals.total.toLocaleString('es-CL')}</strong></span>
                        </div>
                    </div>
                </div>
            `;
        }

        function getTimeSlotText(slot) {
            const slots = {
                'morning': 'Mañana (09:00 - 12:00)',
                'afternoon': 'Tarde (14:00 - 17:00)',
                'evening': 'Noche (18:00 - 20:00)'
            };
            return slots[slot] || slot;
        }
    </script>
</body>
</html>
